{{ extends "chatHMC/Page.html" }}

{{ block title }}
{{ endblock }}

{{ block scripts }}
<script>
    // list of chat messages as JSON dictionaries
    var chatLogData = [];

    // timestamp of page loading to determine when messages were sent
    var timeBase = Date.now();

    // adapting chat from oTree snippets page
    var chat_input = document.getElementById('chat_input');
    
    chat_input.addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            sendMsg();
        }
    });


    // function to log chat
    function logChat(sender, chatText) {
        let timestamp = (Date.now() - timeBase) / 1000;
        
        // create dictionary for current message info
        var currentMsg = {
            sender: sender,
            text: chatText,
            timestamp: timestamp
        };

        // append chatLogData
        chatLogData.push(currentMsg);

        // write chatLog to input field
        document.getElementById('id_chatLog').value = JSON.stringify(chatLogData);

    }
    
    // function to append text in webpage
    function sendMsg() {
        var text = chat_input.value.trim();
        if (text) {
            liveSend({'text': text});
            let msgSpan = document.createElement('span');
            msgSpan.textContent = text;
            let sender = `${js_vars.my_nickname} <img src="{{ static my_avatar }}" width="45px" />`;
            let row = `<div><div class="senderAvatar">${sender}</div><div class="msg selfText">${msgSpan.innerHTML}</div></div><br>`;
            chat_messages.insertAdjacentHTML('beforeend', row);
            
            // scroll messages to bottom
            chat_messages.scrollIntoView({ behavior: 'instant', block: 'end', inline: 'start' })

            // append chat log
            logChat(js_vars.my_code, text)
            
        }
        chat_input.value = ''; 
    }

    // specify messages element
    var chat_messages = document.getElementById('chat_messages');
    
    // specify the number of messsages
    var num_messages = {num: 0};

    // function for live receiving from server
    function liveRecv(data) {
        console.log("received:", data);  
        let text = data.text;
        // check if the chat is finished
        if (text === "chat_exceeded") {
            let reminder = "Your chat is finished. Please click 'Next Page' to continue.";
            showNotification(reminder);
            // document.getElementById('form').submit();
        } else {
            let msgSpan = document.createElement('span');
            msgSpan.textContent = data.text
            if (js_vars.partnerLabel == 'chatbot') {
                var row = `<div><div class="receiverAvatar"><img src="{{ static 'avatar/myBot.png' }}" width="45px" /> MyBot</div><div class="msg botText">${msgSpan.innerHTML}</div></div><br>`;
            } else {
                var row = `<div><div class="receiverAvatar"><img src="{{ static 'avatar/fox.png' }}" width="45px" /> Tommy</div><div class="msg botText">${msgSpan.innerHTML}</div></div><br>`;
            }

            chat_messages.insertAdjacentHTML('beforeend', row);
            // append chat log
            logChat('Bot', data.text)

            // Assign the number as an attribute of num_messages
            num_messages.num = data.num
        };

        // scroll messages to bottom
        chat_messages.scrollIntoView({ behavior: 'instant', block: 'end', inline: 'start' })
    };


    // Get the element ID of the next page button
    var nextButton = document.getElementById("nextButton");
    let reminder = "Please chat at least 5 turns.";
    nextButton.addEventListener("click", function(event) {
        if (num_messages.num < 5){
            showNotification(reminder);
            // Prevent the default reaction, i.e., submitting the form
            event.preventDefault();
        } else {
            document.getElementById('form').submit();
        }
    });

    // function for system notification
    function showNotification(text) {
        const chatBox = document.getElementById('chat_messages');
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = text;
        
        chatBox.appendChild(notification);
        
        // Remove notification after 100 seconds
        setTimeout(() => {
            notification.remove();
        }, 100000);
        
        // Scroll to the bottom
        chatBox.scrollIntoView({ behavior: 'instant', block: 'end', inline: 'start' });
    };

</script>

{{ endblock }}


{{ block content }}
<div class="container">
    {{ if player.participant.partnerLabel == 'human'}}
        <div class="topPart" autofocus>
            <!-- <h2>Chat Instruction</h2><br> -->
            <span style="color:black; font-size: 18px;">
                1. You are paired with a participant in this survey. If your partner asks who you are, say that you are also a participant in this survey.<br>
                2. Your task is to <span style="color:red;">1) share any emotional challenges you've experienced</span>, and <span style="color:red;">2) encourage your partner to talk about their recent worries or concerns</span>. You and your partner need to take turns disclosing your concerns.<br>
                3. <span style="color:red;">If the conversation goes off-topic, kindly guide it back to talking about recent worries or concerns.</span><br>
                4. It is recommended that the conversation consists of 5 to 15 rounds.<br>
                5. Always use a friendly tone and reply in English.<br>
            </span>
        </div>
    {{ elif player.participant.partnerLabel == 'chatbot'}}
        <div class="topPart" autofocus>
            <!-- <h2>Chat with CaringBot</h2><br> -->
            <span style="color:black; font-size: 18px;">
                1. You are paired with a conversational AI named MyBot.<br>
                2. Your task is to <span style="color:red;">1) share any emotional challenges you've experienced</span>, and <span style="color:red;">2) encourage Mybot to talk about their recent worries or concerns</span>. You and Mybot need to take turns disclosing your concerns.<br>
                3. <span style="color:red;">If the conversation goes off-topic, kindly guide it back to talking about recent worries or concerns.</span><br>
                4. It is recommended that the conversation consists of 5 to 15 rounds.<br>
                5. Always use a friendly tone and reply in English.<br>
            </span>
        </div>
    {{ endif }}

    <div class="downPart">
        <!-- div displaying chat messages -->
        <div class="textBox">
            <div id="chat_messages">
            </div>
        </div>
        
        <!-- text input -->
        <div class="inputBox">
            <div class="typeInputBox">
                <input type="text" id="chat_input" placeholder="Type here...">
                <button type="button" onclick="sendMsg()">Send</button>
            </div>
        </div>
        
        <!-- hidden input to save chat log -->
        <input type='hidden' name='chatLog' value='' id='id_chatLog'/>
        <br>

        <!-- oTree timer -->
        <p align="center">
            <!-- Page will auto-advance in:
            <span style="color:red; font-weight: bold">
                <span class="otree-timer__time-left"></span>
            </span> -->
        <button type="button" class="btn btn-primary" id="nextButton">
            Next Page
        </button>
        </p>
    </div>
</div>

{{ endblock }}
